# Быстрый старт: Синхронизация ноды через временную ноду

## Требования

**Рабочая директория:** `gonka/deploy/join`

```bash
cd gonka/deploy/join
```

**Необходимые инструменты:** Docker, Docker Compose, `jq`, `yq`

Установите `yq`, если требуется:
```bash
sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
```

## Предположения

- Вы запускаете скрипты для ноды, развернутой в `gonka/deploy/join`
- Docker-тома должны соответствовать:
  - `.inference:/root/.inference` (для `node` и `api`)
  - `.tmkms:/root/.tmkms` (для `tmkms`)
- В `docker-compose.yml` должны быть фиксированные имена контейнеров:
  - `node` (основная нода)
  - `tmkms` (KMS)

## Краткая инструкция

Для синхронизации ноды с минимальным простоем используйте три скрипта последовательно:

**Шаг 1:** Запустите временную ноду командой `sudo ./temp-node/start-temp.sh` (быстрая синхронизация временной ноды, но downtime основной ноды 2-10 минут) или `sudo ./temp-node/start-temp.sh --from-scratch` (медленная синхронизация из сети, но downtime основной ноды - несколько секунд). Первый вариант остановит основную ноду для копирования БД и снэпшотов, затем восстановит состояние из локального снэпшота. Второй вариант копирует только конфиг и синхронизирует временную ноду из сети без остановки основной, но займет значительно больше времени (часы/дни).

**Шаг 2:** Дождитесь синхронизации командой `./temp-node/wait-temp-sync.sh`, которая мониторит высоту блоков обеих нод и завершится когда разница станет меньше 5 блоков.

**Шаг 3:** Выполните замену состояния командой `sudo ./temp-node/swap-from-temp.sh`, которая остановит основной `api` (он монтирует `.inference`), остановит обе ноды (основную + временную), создаст бэкап текущего состояния основной ноды (`.inference/data.bak`, `.inference/wasm.bak`), перенесет синхронизированное состояние из временной ноды и запустит основную ноду + основной `api`. Скрипт автоматически проверит, что PoC-фаза неактивна, и отменит операцию если бэкап уже существует. После проверки работоспособности удалите временные файлы (`rm -rf .inference-temp .tmkms-temp docker-compose.temp.yml`) и бэкапы.

---

## Команды для копирования

### С восстановлением из локальных снэпшотов
```bash
sudo ./temp-node/start-temp.sh && \
./temp-node/wait-temp-sync.sh && \
sudo ./temp-node/swap-from-temp.sh
```

### С синхронизацией с нуля из сети
```bash
sudo ./temp-node/start-temp.sh --from-scratch && \
./temp-node/wait-temp-sync.sh && \
sudo ./temp-node/swap-from-temp.sh
```
